"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[4412],{5216:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>g,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var s=t(4848),a=t(8453);const o={title:"Task acknowledgement",sidebar_label:"Task acknowledgement",sidebar_position:3},r=void 0,i={id:"guides/task-acknowledgement",title:"Task acknowledgement",description:"Implicit Acknowledgement",source:"@site/docs/002-guides/003-task-acknowledgement.md",sourceDirName:"002-guides",slug:"/guides/task-acknowledgement",permalink:"/kanthorq/docs/guides/task-acknowledgement",draft:!1,unlisted:!1,editUrl:"https://github.com/kanthorlabs/kanthorq/tree/main/packages/create-docusaurus/templates/shared/docs/002-guides/003-task-acknowledgement.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{title:"Task acknowledgement",sidebar_label:"Task acknowledgement",sidebar_position:3},sidebar:"default",previous:{title:"Handle events and tasks",permalink:"/kanthorq/docs/guides/handle-events-and-tasks"},next:{title:"Concepts",permalink:"/kanthorq/docs/category/concepts"}},c={},l=[{value:"Implicit Acknowledgement",id:"implicit-acknowledgement",level:2},{value:"Explicit Acknowledgement",id:"explicit-acknowledgement",level:2},{value:"Transactional Acknowledgement",id:"transactional-acknowledgement",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"implicit-acknowledgement",children:"Implicit Acknowledgement"}),"\n",(0,s.jsx)(n.p,{children:"By default, all subscribers in KanthorQ use implicit acknowledgement. This means that the system automatically acknowledges tasks if no error is returned from your handler. If an error occurs, the system will mark the task as not acknowledged, and it will be retried."}),"\n",(0,s.jsx)(n.p,{children:"The handler interface is defined as follows:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type Handler func(ctx context.Context, msg *Message) error\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"Message"})," struct, passed to the handler, contains information about the event and task:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type Message struct {\n  // the event you push into a stream\n  Event *entities.Event\n  // the task that was generated from the event\n  // contains all necessary about your execution on the event\n  Task  *entities.Task\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"explicit-acknowledgement",children:"Explicit Acknowledgement"}),"\n",(0,s.jsx)(n.p,{children:"In some cases, you may want to acknowledge tasks manually\u2014committing the acknowledgment to the database along with your business logic. This ensures that either everything is committed (including the acknowledgment) or nothing is committed, maintaining data consistency."}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"Message"})," struct provides two methods for manual acknowledgement:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func (msg *Message) Ack(ctx context.Context) error\n// Nack requires a reason parameter, so you can log why the task wasn't acknowledged\nfunc (msg *Message) Nack(ctx context.Context, reason error) error\n"})}),"\n",(0,s.jsxs)(n.admonition,{type:"danger",children:[(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"What happens if Ack or Nack fail?"})}),(0,s.jsx)(n.p,{children:"If you cannot acknowledge the message (which represents a task and a corresponding event) on time, the Availability Subscriber will pick it up and start processing it again if you have set that subscriber."})]}),"\n",(0,s.jsx)(n.p,{children:"Here's a demonstration of how to use Ack and Nack explicitly:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'func(ctx context.Context, msg *subscriber.Message) error {\n  // Accept and acknowledge if the subject is "system.say_hello"\n  if msg.Event.Subject == "system.say_hello" {\n    if err := msg.Ack(ctx); err != nil {\n      // Handle ack error\n    }\n  }\n  // I will miss you don\'t want to say goodbye, not acknowledge it\n  if msg.Event.Subject == "system.say_goodbye" {\n    if err := msg.Nack(ctx, errors.New("not saying goodbye")); err != nil {\n      // Handle nack error\n    }\n  }\n\n  return nil\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(n.a,{href:"https://github.com/kanthorlabs/kanthorq/blob/main/example/acknowledgement/main.go",children:"Acknowledgement example"})," for the complete code."]}),"\n",(0,s.jsx)(n.h2,{id:"transactional-acknowledgement",children:"Transactional Acknowledgement"}),"\n",(0,s.jsx)(n.p,{children:"KanthorQ leverages PostgreSQL\u2019s ACID transactional model to ensure data consistency. This allows you to acknowledge tasks within a transaction, ensuring that both your business logic and the task acknowledgment are committed together."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'kanthorq.Sub(ctx, options, func(ctx context.Context, msg *subscriber.Message) error {\n  // Begin a PostgreSQL transaction:\n  tx, err := conn.Begin(ctx)\n  if err != nil {\n    return err\n  }\n\n  // Accept and acknowledge if the subject is "system.say_hello"\n  if msg.Event.Subject == "system.say_hello" {\n    if err := msg.AckTx(ctx, tx); err != nil {\n      // Handle ack error\n    }\n  }\n  // I will miss you don\'t want to say goodbye, not acknowledge it\n  if msg.Event.Subject == "system.say_goodbye" {\n    if err := msg.NackTx(ctx, errors.New("not saying goodbye"), tx); err != nil {\n      // Handle nack error\n    }\n  }\n\n  if err:=tx.Commit(ctx); err != nil {\n    // Handle any errors that occur during commit\n  }\n})\n'})})]})}function g(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>i});var s=t(6540);const a={},o=s.createContext(a);function r(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);