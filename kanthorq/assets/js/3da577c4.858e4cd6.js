"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[2631],{7134:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>a,toc:()=>c});var s=t(4848),r=t(8453);const i={title:"Handle events and tasks",sidebar_label:"Handle events and tasks",sidebar_position:2},o=void 0,a={id:"guides/handle-events-and-tasks",title:"Handle events and tasks",description:"Every event in KanthorQ generates at least one task. Depending on your requirements, you may need to handle potential failures, such as retrying tasks. This guide demonstrates two ways to manage tasks from your events using a subscriber. The first method is the most convenient, while the second provides more control over how to handle both success and failure scenarios.",source:"@site/docs/002-guides/002-handle-events-and-tasks.md",sourceDirName:"002-guides",slug:"/guides/handle-events-and-tasks",permalink:"/kanthorq/docs/guides/handle-events-and-tasks",draft:!1,unlisted:!1,editUrl:"https://github.com/kanthorlabs/kanthorq/tree/main/packages/create-docusaurus/templates/shared/docs/002-guides/002-handle-events-and-tasks.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{title:"Handle events and tasks",sidebar_label:"Handle events and tasks",sidebar_position:2},sidebar:"default",previous:{title:"Insert events",permalink:"/kanthorq/docs/guides/insert-events"},next:{title:"Task acknowledgement",permalink:"/kanthorq/docs/guides/task-acknowledgement"}},l={},c=[{value:"Using the Subscriber Facade",id:"using-the-subscriber-facade",level:2},{value:"Using the Subscriber Directly",id:"using-the-subscriber-directly",level:2},{value:"Using the Primary Subscriber",id:"using-the-primary-subscriber",level:3},{value:"Using the Retry Subscriber",id:"using-the-retry-subscriber",level:3},{value:"Using the Availability Subscriber",id:"using-the-availability-subscriber",level:3}];function u(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"Every event in KanthorQ generates at least one task. Depending on your requirements, you may need to handle potential failures, such as retrying tasks. This guide demonstrates two ways to manage tasks from your events using a subscriber. The first method is the most convenient, while the second provides more control over how to handle both success and failure scenarios."}),"\n",(0,s.jsx)(n.h2,{id:"using-the-subscriber-facade",children:"Using the Subscriber Facade"}),"\n",(0,s.jsxs)(n.p,{children:["KanthorQ offers two facades: the ",(0,s.jsx)(n.strong,{children:"Publisher Facade"})," for quickly initializing your publisher to insert events into the KanthorQ system, and the ",(0,s.jsx)(n.strong,{children:"Subscriber Facade"})," to register and manage three types of subscribers:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Primary Subscriber"})," \u2013 Handles new incoming events and creates tasks to execute your business logic."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Retry Subscriber"})," \u2013 Manages events that require retries after a failure."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Visibility Subscriber"}),' \u2013 Reprocesses tasks that exceed the visibility timeout and are considered "stuck" in the system.']}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Below is an example similar to the one in the Quickstart guide:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'import (\n  "context"\n  "errors"\n  "fmt"\n  "log"\n  "os"\n  "os/signal"\n  "syscall"\n  "time"\n\n  "github.com/kanthorlabs/kanthorq"\n  "github.com/kanthorlabs/kanthorq/entities"\n  "github.com/kanthorlabs/kanthorq/puller"\n  "github.com/kanthorlabs/kanthorq/subscriber"\n)\n\nfunc main() {\n  // listen for SIGTERM so if you press Ctrl-C you can stop the program\n  ctx, stop := signal.NotifyContext(context.TODO(), os.Interrupt, syscall.SIGINT, syscall.SIGTERM)\n  defer stop()\n\n  var options = &subscriber.Options{\n    Connection: "postgres://postgres:changemenow@localhost:5432/postgres?sslmode=disable",\n    StreamName: entities.DefaultStreamName,\n    ConsumerName: entities.DefaultConsumerName,\n    ConsumerSubjectIncludes: []string{"system.>"},\n    ConsumerAttemptMax: entities.DefaultConsumerAttemptMax,\n    ConsumerVisibilityTimeout: entities.DefaultConsumerVisibilityTimeout,\n    Puller: puller.PullerIn{\n      Size: 100,\n      WaitingTime: 1000,\n    },\n  }\n\n  // Handle events. This goroutine will block until Ctrl-C is pressed\n   err := kanthorq.Sub(ctx, options, func(ctx context.Context, msg *subscriber.Message) error {\n    ts := time.UnixMilli(msg.Event.CreatedAt).Format(time.RFC3339)\n    // print out recevied event\n    fmt.Printf("RECEIVED: %s | %s | %s\\n", msg.Event.Id, msg.Event.Subject, ts)\n    return nil\n  })\n\n  // print out error if any\n  if err != nil && !errors.Is(err, context.Canceled) {\n    log.Fatal(err)\n  }\n}\n'})}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["When using the ",(0,s.jsx)(n.strong,{children:"Subscriber Facade"}),", the handler you provide will be used for all subscribers under this facade. This means you\u2019ll process tasks for new events, retrying events, and stuck events with the same logic in the handler."]})}),"\n",(0,s.jsx)(n.h2,{id:"using-the-subscriber-directly",children:"Using the Subscriber Directly"}),"\n",(0,s.jsx)(n.p,{children:"In certain scenarios, you may want to handle tasks differently for new events and retries. In such cases, you can use the subscriber directly to achieve the desired behavior."}),"\n",(0,s.jsx)(n.h3,{id:"using-the-primary-subscriber",children:"Using the Primary Subscriber"}),"\n",(0,s.jsx)(n.p,{children:"This subscriber handles two main responsibilities:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Scanning the stream for new events that match the filter set during consumer registration."}),"\n",(0,s.jsx)(n.li,{children:"Creating tasks corresponding to the events and returning them to you for execution."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Here\u2019s an example of how to use the Primary Subscriber directly:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'import (\n  "context"\n  "errors"\n  "fmt"\n  "os"\n  "os/signal"\n  "syscall"\n  "time"\n\n  "github.com/kanthorlabs/kanthorq/entities"\n  "github.com/kanthorlabs/kanthorq/pkg/xlogger"\n  "github.com/kanthorlabs/kanthorq/puller"\n  "github.com/kanthorlabs/kanthorq/subscriber"\n  "go.uber.org/zap"\n)\n\nfunc main() {\n  // listen for SIGTERM so if you press Ctrl-C you can stop the program\n  ctx, stop := signal.NotifyContext(context.TODO(), os.Interrupt, syscall.SIGINT, syscall.SIGTERM)\n  defer stop()\n\n  logger := xlogger.New()\n\n  // options is same as the subscriber facade\n  var options = &subscriber.Options{\n    Connection: "postgres://postgres:changemenow@localhost:5432/postgres?sslmode=disable",\n    StreamName: entities.DefaultStreamName,\n    ConsumerName: entities.DefaultConsumerName,\n    ConsumerSubjectIncludes: []string{"system.>"},\n    ConsumerAttemptMax: entities.DefaultConsumerAttemptMax,\n    ConsumerVisibilityTimeout: entities.DefaultConsumerVisibilityTimeout,\n    Puller: puller.PullerIn{\n      Size: 100,\n      WaitingTime: 1000,\n    },\n  }\n  sub, err := subscriber.New(options, logger)\n  if err != nil {\n    panic(err)\n  }\n\n  var timeout = time.Second * 3\n\n  // Starting a subscriber should be use with timeout\n  startctx, cancel := context.WithTimeout(ctx, timeout)\n  defer cancel()\n  if err := sub.Start(startctx); err != nil {\n    panic(err)\n  }\n\n  defer func() {\n    // Graceful shutdown starting\n    // don\'t reuse ctx here because it already done\n    // you also need timeout here\n    stopCtx, stopCancel := context.WithTimeout(context.Background(), timeout)\n    defer stopCancel()\n    if err := sub.Stop(stopCtx); err != nil {\n      logger.Error("subscriber stop with error", zap.Error(err))\n      return\n    }\n  }()\n\n  // The main part, working on up comming events and tasks\n  receiveCtx, receiveCancel := context.WithCancel(ctx)\n  defer receiveCancel()\n\n  // Start receiving events and tasks\n  go func() {\n    err := sub.Receive(receiveCtx, func(ctx context.Context, msg *subscriber.Message) error {\n      ts := time.UnixMilli(msg.Event.CreatedAt).Format(time.RFC3339)\n      // print out recevied event\n      fmt.Printf("RECEIVED: %s | %s | %s\\n", msg.Event.Id, msg.Event.Subject, ts)\n      return nil\n    })\n\n    if err != nil && !errors.Is(err, context.Canceled) {\n      logger.Error("subscriber receive with error", zap.Error(err))\n    }\n\n    // Subscriber is done, should cancel the context to trigger other workflows\n    receiveCancel()\n  }()\n\n  <-receiveCtx.Done()\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["See the ",(0,s.jsx)(n.a,{href:"https://github.com/kanthorlabs/kanthorq/blob/main/example/primary-subscriber/main.go",children:"Primary Subscriber example"})," for the complete code."]}),"\n",(0,s.jsx)(n.h3,{id:"using-the-retry-subscriber",children:"Using the Retry Subscriber"}),"\n",(0,s.jsxs)(n.p,{children:["If an event task fails and is marked as retryable, the Retry Subscriber helps you retry it by transitioning the task from ",(0,s.jsx)(n.code,{children:"Retryable"})," to ",(0,s.jsx)(n.code,{children:"Running"})," and returning the task to you for execution. The code is similar to the ",(0,s.jsx)(n.strong,{children:"Primary Subscriber"}),", with only one line difference:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-git",children:"- sub, err := subscriber.New(options, logger)\n+ sub, err := subscriber.NewRetry(options, logger)\n"})}),"\n",(0,s.jsx)(n.h3,{id:"using-the-availability-subscriber",children:"Using the Availability Subscriber"}),"\n",(0,s.jsxs)(n.p,{children:["For tasks that have exceeded the visibility timeout, the ",(0,s.jsx)(n.strong,{children:"Availability Subscriber"})," pulls them out for reprocessing. As with the ",(0,s.jsx)(n.strong,{children:"Retry Subscriber"}),", you only need to change one line:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-git",children:"- sub, err := subscriber.New(options, logger)\n+ sub, err := subscriber.NewAvailability(options, logger)\n"})})]})}function d(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>a});var s=t(6540);const r={},i=s.createContext(r);function o(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);